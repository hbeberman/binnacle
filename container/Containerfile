# Binnacle Container Worker
# Derived from binnacle-default which provides: bn, copilot, git-wrapper, nss_wrapper setup
FROM binnacle-default:latest

LABEL org.opencontainers.image.title="binnacle-worker"
LABEL org.opencontainers.image.description="AI agent worker with binnacle task tracking"
LABEL org.opencontainers.image.source="https://github.com/hbeberman/binnacle"

# Install additional system dependencies for worker image
# gcc/make: Required for Rust's C linker (compiling native crates)
# Rust toolchain is needed for pre-commit hooks (cargo fmt, clippy, audit)
# diffutils: Required for pre-commit AGENTS.md sync check
# just: Command runner for justfile recipes
# Note: git, jq, curl, ripgrep, fd-find, nss_wrapper come from binnacle-default
RUN dnf install -y \
    wget \
    tree \
    vim \
    unzip \
    python3 \
    python3-pip \
    nodejs \
    npm \
    gcc \
    make \
    diffutils \
    just \
    && dnf clean all

# Install Rust toolchain via rustup
# Required for pre-commit hooks: cargo fmt, cargo clippy, cargo audit
ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:$PATH
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal && \
    rustup component add rustfmt clippy && \
    cargo install cargo-audit && \
    chmod -R a+rw $RUSTUP_HOME $CARGO_HOME

# Install rust-analyzer from prebuilt binary (faster than rustup component)
RUN mkdir -p ~/.local/bin && \
    curl -L https://github.com/rust-lang/rust-analyzer/releases/latest/download/rust-analyzer-x86_64-unknown-linux-gnu.gz | gunzip -c > /usr/local/bin/rust-analyzer && \
    chmod +x /usr/local/bin/rust-analyzer

# Install TypeScript/JavaScript language server for LSP support
# Requires Node.js >= 16 (Fedora 43 provides 22.x)
RUN npm install -g @vtsls/language-server

# Install Lightpanda headless browser for GUI validation
RUN curl -L -o /usr/local/bin/lightpanda \
    https://github.com/lightpanda-io/browser/releases/download/v0.2.1/lightpanda-x86_64-linux && \
    chmod +x /usr/local/bin/lightpanda

# Disable Lightpanda telemetry (belt-and-suspenders with inline env at invocation)
ENV LIGHTPANDA_DISABLE_TELEMETRY=true

# Worker-specific environment variables
ENV BN_AGENT_TYPE=worker
ENV BN_MERGE_TARGET=main

# Copy worker-specific entrypoint (has MCP config injection, LSP setup, etc.)
COPY container/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /workspace
ENTRYPOINT ["/entrypoint.sh"]
