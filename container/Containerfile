# Binnacle Container Worker
# Base: Fedora 43
FROM docker.io/library/fedora:43

LABEL org.opencontainers.image.title="binnacle-worker"
LABEL org.opencontainers.image.description="AI agent worker with binnacle task tracking"
LABEL org.opencontainers.image.source="https://github.com/hbeberman/binnacle"

# Install system dependencies (no Rust needed - we copy pre-built binary)
RUN dnf install -y \
    git \
    curl \
    wget \
    jq \
    ripgrep \
    fd-find \
    tree \
    vim \
    unzip \
    python3 \
    python3-pip \
    && dnf clean all

# Copy binnacle binary (bn container build copies the running binary here)
# For manual builds: cargo build --release && cp target/release/bn container/bn
ARG BN_BINARY_PATH=container/bn
COPY ${BN_BINARY_PATH} /usr/local/bin/bn

# Install bun (JavaScript runtime and package manager)
RUN curl -fsSL https://bun.sh/install | bash
ENV BUN_INSTALL="/root/.bun"
ENV PATH="$BUN_INSTALL/bin:$PATH"

# Install GitHub Copilot CLI
# Note: Requires COPILOT_GITHUB_TOKEN at runtime for auth
RUN bun install -g @github/copilot || true

# Create working directories
RUN mkdir -p /workspace /binnacle /copilot-config

# Set container mode environment variables
ENV BN_CONTAINER_MODE=true
ENV BN_AGENT_TYPE=worker
ENV BN_MERGE_TARGET=main

# Copy entrypoint script
COPY container/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /workspace
ENTRYPOINT ["/entrypoint.sh"]
