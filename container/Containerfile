# Binnacle Container Worker
# Base: Fedora 43
FROM docker.io/library/fedora:43

LABEL org.opencontainers.image.title="binnacle-worker"
LABEL org.opencontainers.image.description="AI agent worker with binnacle task tracking"
LABEL org.opencontainers.image.source="https://github.com/hbeberman/binnacle"

# Install system dependencies (no Rust needed - we copy pre-built binary)
RUN dnf install -y \
    git \
    curl \
    wget \
    jq \
    ripgrep \
    fd-find \
    tree \
    vim \
    unzip \
    python3 \
    python3-pip \
    nodejs \
    npm \
    nss_wrapper \
    && dnf clean all

# Create nss_wrapper template files for default (non-sudo) mode
# Used by entrypoint.sh to provide user identity for Node.js os.userInfo(), git, etc.
# when running as host user (not root)
RUN mkdir -p /etc/nss_wrapper && \
    cp /etc/passwd /etc/nss_wrapper/passwd && \
    cp /etc/group /etc/nss_wrapper/group && \
    chmod 644 /etc/nss_wrapper/passwd /etc/nss_wrapper/group

# Copy binnacle binary (bn container build copies the running binary here)
# For manual builds: cargo build --release && cp target/release/bn container/bn
ARG BN_BINARY_PATH=container/bn
COPY ${BN_BINARY_PATH} /usr/local/bin/bn

# Install GitHub Copilot CLI globally using npm
# Note: Requires COPILOT_GITHUB_TOKEN at runtime for auth
RUN npm install -g @github/copilot || true

# Create working directories
RUN mkdir -p /workspace /binnacle

# Set container mode environment variables
ENV BN_CONTAINER_MODE=true
ENV BN_AGENT_TYPE=worker
ENV BN_MERGE_TARGET=main

# Copy entrypoint script
COPY container/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /workspace
ENTRYPOINT ["/entrypoint.sh"]
