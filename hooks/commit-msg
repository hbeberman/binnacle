#!/usr/bin/env bash
# Binnacle commit-msg hook
# Automatically appends Co-authored-by trailer when an agent session is active

COMMIT_MSG_FILE="$1"

# Check if co-author feature is enabled (default: true)
# Uses bn config get which returns JSON {"key":"...","value":...}
enabled_value=$(bn config get co-author.enabled 2>/dev/null | grep -o '"value":[^,}]*' | cut -d':' -f2 | tr -d ' "' || echo "null")

# If explicitly set to false/no/0, skip
if [[ "$enabled_value" == "false" ]] || [[ "$enabled_value" == "no" ]] || [[ "$enabled_value" == "0" ]]; then
    exit 0
fi

# Check for active agent session via BN_AGENT_SESSION environment variable
# This env var is set by agent.sh and inherited by child processes (including git)
if [[ -z "$BN_AGENT_SESSION" ]] || [[ "$BN_AGENT_SESSION" != "1" ]]; then
    exit 0
fi

# Agent is active - append Co-authored-by trailer if not already present
# Get custom name/email from config, or use defaults
co_author_name=$(bn config get co-author.name 2>/dev/null | grep -o '"value":"[^"]*"' | cut -d'"' -f4 || echo "")
if [[ -z "$co_author_name" ]] || [[ "$co_author_name" == "null" ]]; then
    co_author_name="binnacle-bot"
fi

co_author_email=$(bn config get co-author.email 2>/dev/null | grep -o '"value":"[^"]*"' | cut -d'"' -f4 || echo "")
if [[ -z "$co_author_email" ]] || [[ "$co_author_email" == "null" ]]; then
    co_author_email="noreply@binnacle.bot"
fi

trailer="Co-authored-by: $co_author_name <$co_author_email>"

# Check if trailer already exists (for amend case)
if grep -qF "$trailer" "$COMMIT_MSG_FILE" 2>/dev/null; then
    exit 0
fi

# Append trailer with blank line separator
# First, ensure there's a blank line before trailers
echo "" >> "$COMMIT_MSG_FILE"
echo "$trailer" >> "$COMMIT_MSG_FILE"

exit 0
