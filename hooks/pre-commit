#!/usr/bin/env bash
# Binnacle pre-commit hook
# Validates code formatting and linting before allowing commit

set -e

echo "Running pre-commit checks..."

# Run format check
echo "  → Checking code formatting..."
if ! cargo fmt --check --quiet 2>&1; then
    echo ""
    echo "❌ Code formatting check failed!"
    echo "   Run 'cargo fmt' to fix formatting issues."
    exit 1
fi

# Run clippy
echo "  → Running clippy..."
if ! cargo clippy --all-targets --all-features --quiet -- -D warnings 2>&1; then
    echo ""
    echo "❌ Clippy check failed!"
    echo "   Fix the issues reported above before committing."
    exit 1
fi

# Run JavaScript linting if any .js files are staged
echo "  → Checking for staged JavaScript files..."
staged_js_files=$(git diff --cached --name-only --diff-filter=ACM -- '*.js' 2>/dev/null || true)

if [ -n "$staged_js_files" ]; then
    echo "  → Running JavaScript linting..."
    
    # Check if node_modules exists (ESLint installed)
    if [ ! -d "node_modules" ]; then
        echo ""
        echo "❌ ESLint not installed!"
        echo "   Run 'npm install' to install ESLint."
        exit 1
    fi
    
    # Run ESLint on staged files only
    if ! npx eslint $staged_js_files 2>&1; then
        echo ""
        echo "❌ JavaScript linting failed!"
        echo "   Fix the issues reported above before committing."
        exit 1
    fi
else
    echo "  ✓ No JavaScript files staged, skipping lint"
fi

# Check if AGENTS.md is in sync with embedded blurb
# Uses cargo run to check against the code being committed, not the installed bn
echo "  → Checking AGENTS.md sync..."

repo_root=$(git rev-parse --show-toplevel)

# Extract current binnacle section from AGENTS.md
current_section=$(sed -n '/<!-- BEGIN BINNACLE SECTION -->/,/<!-- END BINNACLE SECTION -->/p' "$repo_root/AGENTS.md" 2>/dev/null || true)

# Get expected content from the code being committed
expected_section=$(cargo run --quiet -- -H system emit agents 2>/dev/null)
emit_exit_code=$?

if [ $emit_exit_code -ne 0 ]; then
    echo "  ⚠ Skipping AGENTS.md sync check (build failed)"
elif [ -n "$expected_section" ]; then
    # Check if diff is available
    if ! command -v diff &> /dev/null; then
        echo "  ⚠ Skipping AGENTS.md sync check (diff not installed)"
    elif ! diff -q <(echo "$current_section") <(echo "$expected_section") >/dev/null 2>&1; then
        echo ""
        echo "❌ AGENTS.md binnacle section is out of sync!"
        echo "   Run 'cargo run -- system init --write-agents-md -y' to update, then stage AGENTS.md"
        exit 1
    fi
fi

# Check version sync between Cargo.toml and README
echo "  → Checking version sync..."

# Check if Cargo.toml is being modified
if git diff --cached --name-only | grep -q '^Cargo.toml$'; then
    # Get the old and new version from Cargo.toml
    old_cargo_version=$(git show HEAD:Cargo.toml 2>/dev/null | grep '^version' | head -1 | sed 's/version = "\(.*\)"/\1/' || echo "")
    new_cargo_version=$(git show :Cargo.toml | grep '^version' | head -1 | sed 's/version = "\(.*\)"/\1/')
    
    # Only check if version actually changed
    if [ "$old_cargo_version" != "$new_cargo_version" ]; then
        # Check if README.md is also being modified and staged
        if ! git diff --cached --name-only | grep -q '^README.md$'; then
            echo ""
            echo "❌ Version sync check failed!"
            echo "   Cargo.toml version changed from $old_cargo_version to $new_cargo_version"
            echo "   but README.md is not staged with matching changes."
            echo ""
            echo "   Update README.md quickstart section to match Cargo.toml version and stage it."
            exit 1
        fi
        
        # Check if the new version appears in staged README.md
        readme_version_count=$(git show :README.md | grep -c "$new_cargo_version" || true)
        
        if [ "$readme_version_count" -lt 2 ]; then
            echo ""
            echo "❌ Version sync check failed!"
            echo "   Cargo.toml version is $new_cargo_version but README.md doesn't reference it enough times."
            echo "   Expected at least 2 occurrences (wget and cargo install lines)."
            echo "   Current count: $readme_version_count"
            echo ""
            echo "   Update README.md quickstart section to match Cargo.toml version."
            exit 1
        fi
        
        echo "  ✓ Version $new_cargo_version is synced in README.md ($readme_version_count occurrences)"
    else
        echo "  ✓ Cargo.toml version unchanged, skipping version sync check"
    fi
else
    echo "  ✓ Cargo.toml not modified, skipping version sync check"
fi

# Run cargo audit for security vulnerabilities
echo "  → Running security audit..."
if ! command -v cargo-audit &> /dev/null; then
    echo ""
    echo "❌ cargo-audit not installed!"
    echo "   Install with: cargo install cargo-audit"
    exit 1
fi

if ! cargo audit 2>&1; then
    echo ""
    echo "❌ Security audit failed!"
    echo "   Fix the vulnerabilities reported above before committing."
    exit 1
fi

# Check for documentation litter (new markdown files in unexpected locations)
echo "  → Checking for documentation litter..."

# Allowed locations for markdown files:
# - docs/           (documentation directory)
# - prds/           (PRD files)
# - Root level known files: README.md, CONTRIBUTING.md, AGENTS.md, PRD.md, 
#                           LICENSE, CHANGELOG.md, IDEAS.md, PROMPT.md
ALLOWED_ROOT_MD="README.md|CONTRIBUTING.md|AGENTS.md|PRD.md|LICENSE|CHANGELOG.md|IDEAS.md|PROMPT.md"

# Get newly added or modified markdown files
new_md_files=$(git diff --cached --name-only --diff-filter=A -- '*.md' 2>/dev/null || true)

litter_found=""
for file in $new_md_files; do
    # Skip allowed directories
    if [[ "$file" == docs/* ]] || [[ "$file" == prds/* ]]; then
        continue
    fi
    
    # Skip allowed root-level files
    basename=$(basename "$file")
    if [[ "$basename" =~ ^($ALLOWED_ROOT_MD)$ ]]; then
        continue
    fi
    
    # Skip if the file is not at root level (nested in other dirs like tests/, src/)
    # Only check for litter at repo root
    if [[ "$file" != "$basename" ]]; then
        continue
    fi
    
    # This is a new markdown file at repo root that's not in the allowed list
    litter_found="$litter_found $file"
done

if [ -n "$litter_found" ]; then
    echo ""
    echo "⚠️  Documentation litter detected!"
    echo "   The following markdown files are being added to unexpected locations:"
    for file in $litter_found; do
        echo "     - $file"
    done
    echo ""
    echo "   Documentation should go in:"
    echo "     - docs/        for general documentation"
    echo "     - prds/        for PRDs and design docs"
    echo "     - Or use: bn doc create <entity> -T 'Title' -c 'content'"
    echo ""
    echo "   If this is intentional, add the filename to ALLOWED_ROOT_MD in hooks/pre-commit"
    exit 1
fi

# Check for web asset changes (web/ directory or GUI server code)
echo "  → Checking for web asset changes..."
staged_web_files=$(git diff --cached --name-only --diff-filter=ACM -- 'web/*' 'src/gui/*' 2>/dev/null || true)

if [ -n "$staged_web_files" ]; then
    echo "  → Web assets changed, running lightpanda validation..."
    
    # Check if lightpanda is installed
    if ! command -v lightpanda &> /dev/null; then
        echo ""
        echo "⚠️  lightpanda not installed!"
        echo "   Web assets (web/ or src/gui/) were modified but cannot be validated."
        echo ""
        echo "   To validate your changes:"
        echo "     1. Install lightpanda: https://github.com/lightpanda-io/browser/releases"
        echo "     2. Run: just gui-check"
        echo ""
        echo "   Skipping validation for now, but CI may fail."
        echo "   Consider installing lightpanda to validate locally before committing."
    else
        # Run validation script (using gui-check.sh which works correctly)
        if ! ./scripts/gui-check.sh 2>&1; then
            echo ""
            echo "❌ Web portal validation failed!"
            echo "   Fix JavaScript errors before committing."
            echo "   Run 'just gui-check' to validate interactively."
            exit 1
        fi
    fi
else
    echo "  ✓ No web assets changed, skipping lightpanda validation"
fi

echo "✅ All pre-commit checks passed!"
exit 0
