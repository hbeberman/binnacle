<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Select Polish Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        h1 {
            color: #4a90e2;
        }
        
        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #6aa8f0;
            font-size: 1.2rem;
        }
        
        .status {
            padding: 1rem;
            background: #1e1e1e;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
        }
        
        .status-line {
            margin: 0.5rem 0;
        }
        
        .status-value {
            color: #4a90e2;
        }
        
        button {
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border: 1px solid #4a90e2;
            border-radius: 4px;
            background: #2a2a2a;
            color: #4a90e2;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        button:hover {
            background: #3a3a3a;
            border-color: #6aa8f0;
        }
        
        button:active {
            background: #1a1a1a;
        }
        
        .test-result {
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            border-radius: 4px;
        }
        
        .test-pass {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4caf50;
        }
        
        .test-fail {
            background: rgba(244, 67, 54, 0.2);
            border-left: 3px solid #f44336;
        }
        
        .node-canvas {
            width: 100%;
            height: 400px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0a0a0a;
            cursor: pointer;
        }
        
        .info {
            color: #888;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .undo-stack {
            max-height: 200px;
            overflow-y: auto;
            background: #1e1e1e;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .undo-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #2a2a2a;
            border-radius: 4px;
            border-left: 3px solid #4a90e2;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ¨ Multi-Select Polish Features Test</h1>
    
    <div class="test-section">
        <h2>1. Selection State Persistence</h2>
        <p class="info">Selection is automatically saved to localStorage and restored across page reloads.</p>
        <div class="status">
            <div class="status-line">Persisted Selection: <span id="persistedSelection" class="status-value">[]</span></div>
            <div class="status-line">Current Selection: <span id="currentSelection" class="status-value">[]</span></div>
        </div>
        <button id="btnAddToSelection">Add bn-test1 to selection</button>
        <button id="btnClearSelection">Clear Selection</button>
        <button id="btnReloadPage">Reload Page (test persistence)</button>
    </div>
    
    <div class="test-section">
        <h2>2. Undo Support for Batch Operations</h2>
        <p class="info">Batch operations can be undone. Try recording and undoing operations.</p>
        <div class="status">
            <div class="status-line">Can Undo: <span id="canUndo" class="status-value">false</span></div>
            <div class="status-line">Undo Stack Size: <span id="undoStackSize" class="status-value">0</span></div>
        </div>
        <button id="btnRecordOp">Record Batch Operation</button>
        <button id="btnUndo">Undo Last Operation</button>
        <button id="btnClearUndo">Clear Undo Stack</button>
        <div id="undoStack" class="undo-stack"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Selection Animations</h2>
        <p class="info">Newly selected nodes show a pulse animation. Click nodes below to see the effect.</p>
        <canvas id="testCanvas" class="node-canvas"></canvas>
        <div class="status">
            <div class="status-line">Animation Active: <span id="animationActive" class="status-value">false</span></div>
            <div class="status-line">Animating Nodes: <span id="animatingNodes" class="status-value">[]</span></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>4. Touch Support (Long-Press)</h2>
        <p class="info">On touch devices, long-press a node to add it to selection. Test on mobile or use Chrome DevTools device emulation.</p>
        <div class="status">
            <div class="status-line">Touch Events Supported: <span id="touchSupported" class="status-value">unknown</span></div>
            <div class="status-line">Last Touch Event: <span id="lastTouchEvent" class="status-value">none</span></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="testResults"></div>
    </div>

    <script type="module">
        import * as state from './js/state.js';
        
        const testResults = document.getElementById('testResults');
        let tests = [];
        
        function addTestResult(name, pass, message = '') {
            const div = document.createElement('div');
            div.className = pass ? 'test-result test-pass' : 'test-result test-fail';
            div.textContent = `${pass ? 'âœ“' : 'âœ—'} ${name}${message ? ': ' + message : ''}`;
            testResults.appendChild(div);
            tests.push({ name, pass });
        }
        
        // Update status displays
        function updateStatusDisplays() {
            const persistedSelection = state.loadFromStorage('selectedNodes', []);
            const currentSelection = state.getSelectedNodes();
            const canUndo = state.canUndo();
            const undoStackSize = state.getUndoStack().length;
            
            document.getElementById('persistedSelection').textContent = JSON.stringify(persistedSelection);
            document.getElementById('currentSelection').textContent = JSON.stringify(currentSelection);
            document.getElementById('canUndo').textContent = canUndo;
            document.getElementById('undoStackSize').textContent = undoStackSize;
            
            // Update undo stack display
            const undoStackDiv = document.getElementById('undoStack');
            const undoStack = state.getUndoStack();
            undoStackDiv.innerHTML = undoStack.length === 0 
                ? '<div style="color: #666;">No operations to undo</div>'
                : undoStack.map((op, i) => `
                    <div class="undo-item">
                        ${i + 1}. ${op.description || op.type} 
                        <span style="color: #666; font-size: 0.8rem;">
                            (${new Date(op.timestamp).toLocaleTimeString()})
                        </span>
                    </div>
                `).join('');
        }
        
        // Subscribe to state changes
        state.subscribe('ui.selectedNodes', updateStatusDisplays);
        state.subscribe('undo.stack', updateStatusDisplays);
        
        // Test 1: Persistence
        document.getElementById('btnAddToSelection').addEventListener('click', () => {
            state.toggleSelection('bn-test1', false);
            updateStatusDisplays();
        });
        
        document.getElementById('btnClearSelection').addEventListener('click', () => {
            state.clearSelection();
            updateStatusDisplays();
        });
        
        document.getElementById('btnReloadPage').addEventListener('click', () => {
            location.reload();
        });
        
        // Test 2: Undo
        let opCounter = 0;
        document.getElementById('btnRecordOp').addEventListener('click', () => {
            opCounter++;
            const testOp = {
                type: 'test-batch-operation',
                description: `Test operation #${opCounter}`,
                changes: [],
                undo: () => {
                    console.log(`Undoing operation #${opCounter}`);
                    state.addToast({
                        type: 'success',
                        message: `Undid operation #${opCounter}`,
                        duration: 2000
                    });
                }
            };
            state.recordBatchOperation(testOp);
            updateStatusDisplays();
        });
        
        document.getElementById('btnUndo').addEventListener('click', () => {
            try {
                const undone = state.undoLastOperation();
                if (undone) {
                    console.log('Undone:', undone);
                } else {
                    state.addToast({
                        type: 'warning',
                        message: 'Nothing to undo',
                        duration: 2000
                    });
                }
            } catch (e) {
                console.error('Undo failed:', e);
                state.addToast({
                    type: 'error',
                    message: 'Undo failed: ' + e.message,
                    duration: 3000
                });
            }
            updateStatusDisplays();
        });
        
        document.getElementById('btnClearUndo').addEventListener('click', () => {
            state.clearUndoStack();
            updateStatusDisplays();
        });
        
        // Test 3: Animations (simplified - just check that animation tracking exists)
        // Full animation test would require importing renderer
        document.getElementById('animationActive').textContent = 'N/A (requires full graph)';
        document.getElementById('animatingNodes').textContent = 'N/A (requires full graph)';
        
        // Test 4: Touch support
        const touchSupported = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        document.getElementById('touchSupported').textContent = touchSupported ? 'Yes' : 'No';
        
        document.addEventListener('touchstart', (e) => {
            document.getElementById('lastTouchEvent').textContent = 'touchstart';
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            document.getElementById('lastTouchEvent').textContent = 'touchend';
        }, { passive: true });
        
        // Run automated tests
        setTimeout(() => {
            // Test: Persistence functions exist
            addTestResult('Persistence functions exist', 
                typeof state.persistSelection === 'function' &&
                typeof state.restoreSelection === 'function' &&
                typeof state.clearPersistedSelection === 'function'
            );
            
            // Test: Undo functions exist
            addTestResult('Undo functions exist',
                typeof state.recordBatchOperation === 'function' &&
                typeof state.undoLastOperation === 'function' &&
                typeof state.canUndo === 'function' &&
                typeof state.getUndoStack === 'function'
            );
            
            // Test: Selection persistence works
            state.setSelectedNodes(['bn-test-a', 'bn-test-b']);
            state.persistSelection();
            const persisted = state.loadFromStorage('selectedNodes', []);
            addTestResult('Selection persistence works',
                persisted.length === 2 &&
                persisted.includes('bn-test-a') &&
                persisted.includes('bn-test-b')
            );
            
            // Test: Undo stack works
            state.clearUndoStack();
            addTestResult('Undo stack starts empty', state.getUndoStack().length === 0);
            
            const testOp = {
                type: 'test',
                description: 'Test op',
                undo: () => {}
            };
            state.recordBatchOperation(testOp);
            addTestResult('Can record operations', state.getUndoStack().length === 1);
            addTestResult('Can undo check works', state.canUndo() === true);
            
            state.undoLastOperation();
            addTestResult('Undo removes from stack', state.getUndoStack().length === 0);
            
            // Test: Touch handler module exists
            import('./js/utils/touch-handler.js').then(module => {
                addTestResult('Touch handler module exists',
                    typeof module.addLongPressHandler === 'function' &&
                    typeof module.addCanvasLongPress === 'function'
                );
            }).catch(e => {
                addTestResult('Touch handler module exists', false, e.message);
            });
            
            // Initial update
            updateStatusDisplays();
            
            // Summary
            setTimeout(() => {
                const passed = tests.filter(t => t.pass).length;
                const total = tests.length;
                const summary = document.createElement('div');
                summary.className = passed === total ? 'test-result test-pass' : 'test-result test-fail';
                summary.innerHTML = `<strong>Summary: ${passed}/${total} tests passed</strong>`;
                testResults.appendChild(summary);
            }, 100);
        }, 100);
    </script>
</body>
</html>
