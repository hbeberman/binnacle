<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binnacle - Agent Navigation Graph</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§­</text></svg>">
    
    <!-- Base styles and theme -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/themes/dark.css">
    
    <!-- Component styles -->
    <link rel="stylesheet" href="/css/components/sidebar.css">
    <link rel="stylesheet" href="/css/components/graph.css">
    <link rel="stylesheet" href="/css/components/info-panel.css">
    <link rel="stylesheet" href="/css/components/available-work-pane.css">
    <link rel="stylesheet" href="/css/components/active-task-pane.css">
    <link rel="stylesheet" href="/css/components/recently-completed-pane.css">
    <link rel="stylesheet" href="/css/components/connection-status.css">
    <link rel="stylesheet" href="/css/components/connection-picker.css">
    <link rel="stylesheet" href="/css/components/readonly-indicator.css">
    <link rel="stylesheet" href="/css/components/doc-viewer.css">
    <link rel="stylesheet" href="/css/components/edge-info-panel.css">
    <link rel="stylesheet" href="/css/components/graph-controls.css">
    <link rel="stylesheet" href="/css/components/node-list.css">
    <link rel="stylesheet" href="/css/components/node-detail-modal.css">
    <link rel="stylesheet" href="/css/components/node-detail-pane.css">
    <link rel="stylesheet" href="/css/components/agent-cards.css">
    
    <style>
        /* Additional layout styles for the full app */
        .header {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            font-size: 1.5rem;
        }
        
        .version-badge {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }
        
        .nav-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .nav-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .nav-btn:hover {
            background: var(--accent-blue);
        }
        
        .nav-btn.active {
            background: var(--accent-blue);
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            gap: 1rem;
        }
        
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .view {
            display: none;
            width: 100%;
            height: 100%;
        }
        
        .view.active {
            display: block;
        }
        
        #graph-view {
            position: relative;
        }
        
        #graph-canvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }
        
        #graph-canvas:active {
            cursor: grabbing;
        }
        
        /* Nodes view (list) */
        #nodes-view {
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        #nodes-view h2 {
            margin: 0 0 1.5rem 0;
            flex-shrink: 0;
        }
        
        #node-list {
            flex: 1;
            overflow: hidden;
        }
        
        .node-list {
            display: grid;
            gap: 1rem;
        }
        
        .node-card {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-blue);
        }
        
        /* Agents view */
        #agents-view {
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        #agents-view h2 {
            margin: 0 0 1.5rem 0;
            flex-shrink: 0;
        }
        
        #agents-list {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Log view */
        #log-view {
            padding: 2rem;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container" id="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="header-title">
                    ðŸ§­ Binnacle 
                    <span class="version-badge" id="version-badge">v0.0.0</span>
                </h1>
                <p class="subtitle">Agent Navigation Graph</p>
                <nav class="nav-buttons">
                    <button class="nav-btn active" data-view="graph">Graph</button>
                    <button class="nav-btn" data-view="nodes">Nodes</button>
                    <button class="nav-btn" data-view="agents">Agents</button>
                    <button class="nav-btn" data-view="log">Activity Log</button>
                </nav>
            </div>
            <div class="header-right">
                <!-- Available work and active task panes will be inserted here -->
                <div id="available-work-container"></div>
                <div id="active-task-container"></div>
                <div id="recently-completed-container"></div>
            </div>
        </header>
        
        <!-- Main content area -->
        <div class="main-content">
            <!-- Graph view -->
            <div class="view active" id="graph-view">
                <canvas id="graph-canvas"></canvas>
            </div>
            
            <!-- Nodes list view -->
            <div class="view" id="nodes-view">
                <div class="nodes-view-header">
                    <div class="search-container">
                        <input type="text" id="nodes-search" class="search-input" placeholder="Search nodes...">
                        <button id="clear-search" class="clear-search-btn" style="display: none;">âœ•</button>
                    </div>
                    <label class="toggle-container">
                        <input type="checkbox" id="nodes-hide-completed" checked>
                        <span>Hide completed</span>
                    </label>
                </div>
                <div class="node-list" id="node-list"></div>
            </div>
            
            <!-- Agents view -->
            <div class="view" id="agents-view">
                <h2>Agents</h2>
                <div id="agents-list"></div>
            </div>
            
            <!-- Activity log view -->
            <div class="view" id="log-view">
                <h2>Activity Log</h2>
                <div id="activity-log"></div>
            </div>
        </div>
    </div>
    
    <!-- Info panel and overlays will be mounted dynamically -->
    
    <script type="module">
        // Import all necessary modules
        import * as state from './js/state.js';
        import * as graph from './js/graph/index.js';
        import * as connection from './js/connection/index.js';
        import { initializeSidebar } from './js/components/sidebar.js';
        import { initializeAgentList } from './js/components/agent-list.js';
        import { initializeAgentCards } from './js/components/agent-cards.js';
        import { createInfoPanel, initializeInfoPanel, showInfoPanel, updateInfoPanelContent } from './js/components/info-panel.js';
        import { mountDocViewer, showDocViewer } from './js/components/doc-viewer.js';
        import { mountNodeDetailModal, showNodeDetailModal } from './js/components/node-detail-modal.js';
        import { mountNodeDetailPane, showNodeDetailPane } from './js/components/node-detail-pane.js';
        import { createAvailableWorkPane } from './js/components/available-work-pane.js';
        import { createActiveTaskPane } from './js/components/active-task-pane.js';
        import { createRecentlyCompletedPane } from './js/components/recently-completed-pane.js';
        import { mountReadonlyIndicator } from './js/components/readonly-indicator.js';
        import { mountGraphControls } from './js/components/graph-controls.js';
        import { initializeNodeList } from './js/components/node-list.js';
        
        // Get container element
        const container = document.getElementById('app-container');
        const canvas = document.getElementById('graph-canvas');
        const graphView = document.getElementById('graph-view');
        
        // Initialize sidebar with search functionality in graph view
        initializeSidebar(graphView, (query) => {
            console.log('Search query:', query);
            // TODO: Implement graph search filtering
        });
        
        // Mount graph controls to graph view (includes inline zoom controls)
        mountGraphControls(graphView, {
            onSearch: (query) => {
                console.log('Graph search query:', query);
                // TODO: Implement graph search filtering
            },
            onHideCompletedToggle: (hideCompleted) => {
                console.log('Hide completed:', hideCompleted);
                // TODO: Implement hide completed filtering
            },
            onAutoFollowToggle: (autoFollow) => {
                console.log('Auto-follow:', autoFollow);
                // TODO: Implement auto-follow behavior
            },
            onZoomIn: () => {
                graph.zoomIn();
            },
            onZoomOut: () => {
                graph.zoomOut();
            },
            updateZoomLevel: (zoomLevelElement) => {
                const zoom = graph.getZoom ? graph.getZoom() : 1.0;
                const percentage = Math.round(zoom * 100);
                zoomLevelElement.textContent = `${percentage}%`;
            }
        });
        
        // Initialize agent list (sidebar)
        initializeAgentList('#agents-sidebar-list');
        
        // Initialize agent cards (agents view)
        initializeAgentCards('#agents-list');
        
        // Initialize node list
        initializeNodeList('#node-list', {
            onNodeClick: (node) => {
                console.log('Node clicked in list:', node);
                // Switch to graph view and show the node
                switchView('graph');
                updateInfoPanelContent(infoPanel, node, [], [], []);
                showInfoPanel(infoPanel);
                // TODO: Pan to the node in the graph
            },
            onInfoClick: (nodeId) => {
                console.log('Info clicked for node:', nodeId);
                showNodeDetailModal(nodeId);
            }
        });
        
        // Initialize nodes search
        const nodesSearchInput = document.getElementById('nodes-search');
        const clearSearchBtn = document.getElementById('clear-search');
        
        if (nodesSearchInput && clearSearchBtn) {
            nodesSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                state.set('ui.searchQuery', query);
                clearSearchBtn.style.display = query ? 'block' : 'none';
            });
            
            clearSearchBtn.addEventListener('click', () => {
                nodesSearchInput.value = '';
                state.set('ui.searchQuery', '');
                clearSearchBtn.style.display = 'none';
                nodesSearchInput.focus();
            });
        }
        
        // Initialize nodes hide completed toggle
        const nodesHideCompletedToggle = document.getElementById('nodes-hide-completed');
        if (nodesHideCompletedToggle) {
            // Set initial state from storage
            const hideCompleted = state.get('ui.hideCompleted');
            nodesHideCompletedToggle.checked = hideCompleted !== false; // default to true
            
            nodesHideCompletedToggle.addEventListener('change', (e) => {
                state.set('ui.hideCompleted', e.target.checked);
            });
        }
        
        // Create and mount info panel
        const infoPanel = createInfoPanel();
        container.appendChild(infoPanel);
        initializeInfoPanel(infoPanel, {
            onClose: () => console.log('Info panel closed'),
            onTabChange: (tab) => console.log('Tab changed:', tab),
            onQueueToggle: (nodeId) => {
                console.log('Queue toggle:', nodeId);
                // TODO: Implement queue toggle
            },
            onDocOpen: () => {
                const docOpenSection = document.getElementById('info-panel-doc-open-section');
                const docId = docOpenSection?.dataset?.docId;
                if (docId) {
                    showDocViewer(docId);
                }
            },
            onViewFullLog: () => {
                // Switch to log view
                switchView('log');
            }
        });
        
        // Mount doc viewer overlay
        mountDocViewer(container);
        
        // Mount node detail modal
        mountNodeDetailModal(container);
        
        // Mount node detail pane (side panel for double-click)
        mountNodeDetailPane(container);
        
        // Create and mount available work pane
        const availableWorkPane = createAvailableWorkPane();
        document.getElementById('available-work-container').appendChild(availableWorkPane);
        
        // Create and mount active task pane
        const activeTaskPane = createActiveTaskPane();
        document.getElementById('active-task-container').appendChild(activeTaskPane);
        
        // Create and mount recently completed pane
        const recentlyCompletedPane = createRecentlyCompletedPane();
        document.getElementById('recently-completed-container').appendChild(recentlyCompletedPane);
        
        // Initialize graph
        graph.init(canvas, {
            onNodeClick: (node) => {
                console.log('Node clicked:', node);
                // Show info panel for the clicked node
                updateInfoPanelContent(infoPanel, node, [], [], []);
                showInfoPanel(infoPanel);
            },
            onNodeHover: (node) => {
                if (node) {
                    graph.setHoveredNode(node.id);
                } else {
                    graph.setHoveredNode(null);
                }
            },
            onEdgeClick: (edge) => {
                console.log('Edge clicked:', edge);
                // TODO: Show edge info panel
            },
            onNodeDoubleClick: (node) => {
                console.log('Node double-clicked:', node);
                // Show detail pane for the double-clicked node
                showNodeDetailPane(node.id);
            }
        });
        
        // View switching
        const navButtons = document.querySelectorAll('.nav-btn');
        const views = document.querySelectorAll('.view');
        
        function switchView(viewName) {
            // Update button states
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });
            
            // Update view visibility
            views.forEach(view => {
                view.classList.toggle('active', view.id === `${viewName}-view`);
            });
        }
        
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                switchView(btn.dataset.view);
                state.set('ui.currentView', btn.dataset.view);
            });
        });
        
        // Watch for currentView changes from other parts of the app
        state.watch('ui.currentView', (newView) => {
            switchView(newView);
        });
        
        // Fetch version
        async function fetchVersion() {
            try {
                const response = await fetch('/api/version');
                if (response.ok) {
                    const data = await response.json();
                    const versionBadge = document.getElementById('version-badge');
                    if (versionBadge && data.version) {
                        versionBadge.textContent = `v${data.version}`;
                        versionBadge.title = `Version ${data.version}`;
                    }
                }
            } catch (error) {
                console.warn('Failed to fetch version:', error);
            }
        }
        
        // Initialize connection
        async function initializeApp() {
            // Load user preferences from storage
            state.initFromStorage();
            
            // Fetch version
            await fetchVersion();
            
            // Detect connection mode
            const detection = connection.detectMode();
            
            // If no mode detected and we're served from a server (not file://),
            // auto-connect to WebSocket on the same origin
            if (detection.mode === state.ConnectionMode.NONE && 
                window.location.protocol !== 'file:') {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                console.log('Auto-connecting to WebSocket:', wsUrl);
                
                await connection.connect(wsUrl, {
                    onStateChange: () => {
                        // Trigger graph update when data changes
                        console.log('State updated from server');
                    }
                });
            } else {
                // Apply detected mode (archive or explicit WebSocket URL)
                await connection.applyDetectedMode(detection);
                
                // If WebSocket mode, connect
                if (detection.mode === state.ConnectionMode.WEBSOCKET && detection.wsUrl) {
                    await connection.connect(detection.wsUrl, {
                        onStateChange: () => {
                            console.log('State updated from server');
                        }
                    });
                }
                // TODO: If archive mode, load archive
                // TODO: If NONE mode on file://, show connection picker
            }
            
            // Start graph animation
            graph.startAnimation();
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            graph.resizeCanvas();
        });
        
        // Start the app
        initializeApp().catch(err => {
            console.error('Failed to initialize app:', err);
        });
    </script>
</body>
</html>
